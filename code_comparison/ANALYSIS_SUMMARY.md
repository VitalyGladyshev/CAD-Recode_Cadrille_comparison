# Итоговый анализ моделей CAD-Recode и Cadrille

## Обзор

Этот документ представляет итоговый анализ двух моделей генерации CAD-кода: **CAD-Recode** и **Cadrille**. Обе модели построены на базе моделей Qwen, но используют разные подходы к модификации и поддержке различных типов входных данных.

## Ключевые выводы

### 1. Архитектурные различия

**CAD-Recode:**
- Базовая модель: `Qwen2ForCausalLM` (чистая языковая модель)
- Поддержка модальностей: **Только точечные облака (PC)**
- Стратегия: Минимальные изменения базовой модели
- Добавлен один компонент: `FourierPointEncoder`

**Cadrille:**
- Базовая модель: `Qwen2VLForConditionalGeneration` (мультимодальная модель)
- Поддержка модальностей: Текст + PC + Изображения + Множественные изображения (видео)
- Стратегия: Использование всей функциональности базовой модели + добавление PC
- Добавлены два компонента: `FourierEmbedder` и `FourierPointEncoder`

### 2. Обработка точечных облаков

**Общие черты:**
- Обе модели используют Fourier Point Encoding с одинаковыми параметрами (`num_freqs=8`, `include_pi=False`)
- Одинаковая формула: `cat([points, sin(freqs * points), cos(freqs * points)])`
- Выходная размерность перед проекцией: 51
- Проекция в `hidden_size` через `nn.Linear(51, hidden_size)`

**Различия в интеграции:**

| Аспект | CAD-Recode | Cadrille |
|--------|------------|----------|
| Маркировка позиций | `attention_mask == -1` | Динамический расчет `start_idxs` |
| Метод встраивания | Векторная операция `[mask == -1]` | Цикл по батчу с `start_idxs` |
| Подготовка данных | Явное создание pad токенов | Добавление в `collate()` |

### 3. Мультимодальность Cadrille

**Обработка текста:**
- Использует chat template через `processor.apply_chat_template()`
- Поддержка диалоговой структуры (user/assistant)
- Режим train: `add_generation_prompt=False`
- Режим eval: `add_generation_prompt=True`

**Обработка изображений:**
- Через встроенный visual encoder от Qwen2VL
- Использование `image_token_id` для маркировки позиций
- Встраивание через `masked_scatter()`

**Обработка "видео" (множественных изображений):**
- **ВАЖНО:** Это не настоящее видео, а список изображений одного 3D объекта с разных ракурсов
- Рендеринг mesh с 4 ракурсов: `fronts = [[1,1,1], [-1,-1,-1], [-1,1,-1], [1,-1,1]]`
- Объединение в зависимости от `num_imgs` (1, 2 или 4 изображения)
- Обработка через `video_token_id` и visual encoder

### 4. Процессы обучения и инференса

**Обучение:**

| Аспект | Cadrille | CAD-Recode |
|--------|----------|------------|
| Chat template | Да | Нет |
| Формирование labels | Через `find_assistant_content_sublist_indexes()` | Прямое формирование |
| Специальные токены | 151644, 77091, 151645 | Стандартные |
| Поддержка модальностей | PC + IMG + TEXT | Только PC |

**Инференс:**

| Аспект | Cadrille | CAD-Recode |
|--------|----------|------------|
| Подготовка данных | `collate()` функция | Прямая подготовка |
| Chat template | Да (`add_generation_prompt=True`) | Нет |
| Декодирование | `processor.batch_decode()` | `extract_code()` (ручная) |
| Обработка батча | Векторизованная | По одному элементу |

### 5. Оптимизации

**Общие оптимизации:**
- Использование `bfloat16` для экономии памяти
- Flash Attention 2 для ускорения вычислений
- Кэширование (`past_key_values`) для инкрементальной генерации
- Point embeddings встраиваются только на первом проходе

**Специфичные для Cadrille:**
- RoPE с учетом визуальных токенов
- Кэширование визуальных токенов
- Поддержка смешанных батчей

**Специфичные для CAD-Recode:**
- Векторные операции для встраивания PC
- Простая структура для быстрой генерации

## Методы модификации базовых моделей

### CAD-Recode: Минималистичный подход

**Изменения:**
1. Добавлен `FourierPointEncoder` для кодирования PC
2. Модифицирован `forward()` для интеграции point embeddings
3. Использование `attention_mask == -1` для маркировки позиций PC

**Преимущества:**
- Простота реализации
- Легкость понимания
- Минимальные изменения в архитектуре
- Быстрая генерация

**Недостатки:**
- Ограничен только PC
- Нет поддержки других модальностей

### Cadrille: Расширенный подход

**Изменения:**
1. Добавлены `FourierEmbedder` и `FourierPointEncoder`
2. Модифицирован `forward()` для интеграции PC с визуальными токенами
3. Использование всей функциональности Qwen2VL

**Преимущества:**
- Поддержка множественных модальностей
- Гибкая архитектура
- Использование всех возможностей базовой модели

**Недостатки:**
- Более сложная реализация
- Больше параметров модели
- Больше вычислений на первом проходе

## Последовательность операций генерации

### CAD-Recode

1. Загрузка STL файла
2. Нормализация mesh
3. Генерация Point Cloud (256 точек)
4. Подготовка входных данных (`input_ids`, `attention_mask`)
5. Генерация токенов через `model.generate()`
6. Декодирование через `extract_code()`
7. Сохранение в файл

### Cadrille

1. Загрузка данных из датасета
2. Подготовка батча через `collate()`
3. Формирование chat template
4. Обработка визуальных данных (если есть)
5. Генерация токенов через `model.generate()`
6. Декодирование через `processor.batch_decode()`
7. Сохранение в файлы

## Рекомендации

### Когда использовать CAD-Recode

- У вас есть только точечные облака
- Нужна максимальная скорость инференса
- Требуется простая архитектура
- Ограниченные ресурсы

### Когда использовать Cadrille

- У вас есть доступ к изображениям или текстовым описаниям
- Нужна гибкость в выборе модальностей
- Качество генерации важнее скорости
- Достаточные ресурсы

## Документация

Детальный анализ представлен в следующих документах:

1. **ARCHITECTURE_COMPARISON.md** - Детальное сравнение архитектур, обработки PC, мультимодальных входов
2. **SEQUENCE_DIAGRAMS.md** - Диаграммы последовательности операций для обеих моделей
3. **TRAINING_INFERENCE_ANALYSIS.md** - Анализ процессов обучения и инференса
4. **MODIFICATION_METHODS.md** - Методы доработки базовых моделей Qwen
5. **VISUALIZATIONS/** - Папка с диаграммами (Mermaid):
   - `architecture_comparison.md` - Архитектурные диаграммы
   - `training_flow.md` - Диаграммы процессов обучения
   - `inference_flow.md` - Диаграммы процессов инференса

## Заключение

Обе модели демонстрируют эффективные подходы к генерации CAD-кода из различных типов входных данных. CAD-Recode фокусируется на простоте и эффективности для работы только с точечными облаками, в то время как Cadrille предоставляет гибкую мультимодальную архитектуру для работы с различными типами входов.

Выбор модели зависит от конкретных требований проекта: доступных данных, требований к скорости, доступных ресурсов и необходимой функциональности.
