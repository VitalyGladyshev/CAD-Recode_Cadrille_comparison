#!/usr/bin/env python3
"""
–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –º–æ–¥–µ–ª–µ–π CAD –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º Chamfer Distance –∏ IoU
–°–æ–≤–º–µ—Å—Ç–∏–º —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∫–∞–∫ CAD-Recode, —Ç–∞–∫ –∏ Cadrille
"""
import os
import trimesh
import numpy as np
import cadquery as cq
from tqdm import tqdm
from functools import partial
from scipy.spatial import cKDTree
from collections import defaultdict
from argparse import ArgumentParser
from multiprocessing import Pool
import time
import subprocess
import sys
import json
import tempfile
import logging
import re
import inspect

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
DEBUG_MODE = False

def compound_to_mesh(compound) -> 'trimesh.Trimesh | None':
    """
    –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç CadQuery compound –æ–±—ä–µ–∫—Ç –≤ trimesh mesh.
    
    –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ç–µ—Å—Å–µ–ª—è—Ü–∏—é CadQuery compound –≤ —Ç—Ä–µ—É–≥–æ–ª—å–Ω—É—é —Å–µ—Ç–∫—É —Å –∑–∞–¥–∞–Ω–Ω—ã–º–∏
    –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
    CadQuery –≤ —Ñ–æ—Ä–º–∞—Ç, –ø—Ä–∏–≥–æ–¥–Ω—ã–π –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫.
    
    Args:
        compound: CadQuery compound –æ–±—ä–µ–∫—Ç –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.
            –î–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –º–µ—Ç–æ–¥ tessellate() –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–µ—É–≥–æ–ª—å–Ω–æ–π —Å–µ—Ç–∫–∏.
    
    Returns:
        trimesh.Trimesh or None: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π mesh –æ–±—ä–µ–∫—Ç –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
            Mesh —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–µ—Ä—à–∏–Ω—ã –∏ –≥—Ä–∞–Ω–∏ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–æ–π —Å–µ—Ç–∫–∏.
    
    Raises:
        AttributeError: –ï—Å–ª–∏ compound –Ω–µ –∏–º–µ–µ—Ç –º–µ—Ç–æ–¥–∞ tessellate()
        ValueError: –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Å–µ–ª—è—Ü–∏–∏ –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
    
    Note:
        –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Å–µ–ª—è—Ü–∏–∏: tolerance=0.001, angularTolerance=0.1.
        –≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ç–æ—á–Ω–æ—Å—Ç—å—é –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.
    
    Example:
        >>> import cadquery as cq
        >>> box = cq.Workplane('XY').box(10, 10, 10)
        >>> mesh = compound_to_mesh(box.val())
        >>> print(f"–í–µ—Ä—à–∏–Ω: {len(mesh.vertices)}, –ì—Ä–∞–Ω–µ–π: {len(mesh.faces)}")
    """
    try:
        vertices, faces = compound.tessellate(0.001, 0.1)
        if len(vertices) == 0 or len(faces) == 0:
            logger.warning("–ü—É—Å—Ç–∞—è –º–æ–¥–µ–ª—å –ø–æ—Å–ª–µ —Ç–µ—Å—Å–µ–ª—è—Ü–∏–∏")
            return None
        return trimesh.Trimesh([(v.x, v.y, v.z) for v in vertices], faces)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ compound –≤ mesh: {e}")
        return None

def extract_cadquery_object(code_content: str, filename: str = None):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ CadQuery –æ–±—ä–µ–∫—Ç–∞ –∏–∑ –∫–æ–¥–∞.
    
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–¥ –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –∏ –∏—â–µ—Ç CadQuery –æ–±—ä–µ–∫—Ç—ã —Å—Ä–µ–¥–∏
    –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–æ–¥–∞ –æ—Ç —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
    (Cadrille, CAD-Recode) –∏ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤.
    
    –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–æ–¥–∞ (—É–¥–∞–ª–µ–Ω–∏–µ show_object, export, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤)
        2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ —Å CadQuery
        3. –ü–æ–∏—Å–∫ CadQuery –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        4. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø–æ–∏—Å–∫ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–∏ –∫–æ–¥–∞
        5. –í–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
    
    Args:
        code_content (str): –°–æ–¥–µ—Ä–∂–∏–º–æ–µ Python —Ñ–∞–π–ª–∞ —Å CadQuery –∫–æ–¥–æ–º.
            –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π Python –∫–æ–¥ —Å –∏–º–ø–æ—Ä—Ç–æ–º cadquery.
        filename (str, optional): –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫.
            –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
            –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é None.
    
    Returns:
        CadQuery object or None: –ü–æ—Å–ª–µ–¥–Ω–∏–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π CadQuery –æ–±—ä–µ–∫—Ç –∏–ª–∏ None,
            –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
    
    Raises:
        SyntaxError: –ï—Å–ª–∏ –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
        NameError: –ï—Å–ª–∏ –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        Exception: –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞
    
    Note:
        –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª—è–µ—Ç –≤—ã–∑–æ–≤—ã show_object() –∏ export() –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è
        –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
        –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞.
    
    Example:
        >>> code = '''
        ... import cadquery as cq
        ... w0 = cq.Workplane('XY')
        ... result = w0.box(10, 10, 10)
        ... '''
        >>> obj = extract_cadquery_object(code)
        >>> print(type(obj))
        <class 'cadquery.cq.Workplane'>
    """
    try:
        # –°–æ–∑–¥–∞–µ–º –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
        local_vars = {}
        global_vars = {
            '__builtins__': __builtins__,
            'cadquery': cq,
            'cq': cq,
            '__name__': '__main__'
        }
        
        # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–¥–∞ - —É–¥–∞–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        lines = code_content.split('\n')
        cleaned_lines = []
        
        for line in lines:
            # –£–¥–∞–ª—è–µ–º show_object() –≤—ã–∑–æ–≤—ã
            if 'show_object(' in line or 'show(' in line:
                continue
            # –£–¥–∞–ª—è–µ–º —ç–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–∞–π–ª—ã
            if '.export(' in line or '.val().export(' in line:
                continue
            # –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            if line.strip().startswith('#'):
                continue
            cleaned_lines.append(line)
        
        cleaned_code = '\n'.join(cleaned_lines)
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–¥
        exec(cleaned_code, global_vars, local_vars)
        
        # –ü–æ–∏—Å–∫ CadQuery –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
        cadquery_objects = []
        
        for var_name, var_value in local_vars.items():
            # –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∏–º–µ–Ω–∏ –∫–ª–∞—Å—Å–∞ (—Å–æ–¥–µ—Ä–∂–∏—Ç 'cadquery')
            # –≠—Ç–æ —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ CadQuery –æ–±—ä–µ–∫—Ç–æ–≤
            if hasattr(var_value, '__class__') and 'cadquery' in str(var_value.__class__):
                cadquery_objects.append((var_name, var_value))
            # –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–µ—Ç–æ–¥–∞ .val() - —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫ CadQuery –æ–±—ä–µ–∫—Ç–æ–≤
            # –ú–µ—Ç–æ–¥ .val() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç compound –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ —Ç–µ—Å—Å–µ–ª–∏—Ä–æ–≤–∞—Ç—å
            elif hasattr(var_value, 'val') and callable(var_value.val):
                try:
                    val_result = var_value.val()
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–º–µ–µ—Ç –º–µ—Ç–æ–¥ tessellate (–ø—Ä–∏–∑–Ω–∞–∫ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞)
                    if hasattr(val_result, 'tessellate'):
                        cadquery_objects.append((var_name, var_value))
                except:
                    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ .val() - —ç—Ç–æ –Ω–µ CadQuery –æ–±—ä–µ–∫—Ç
                    pass
        
        if not cadquery_objects:
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –∏—â–µ–º –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–∏
            logger.debug("–ù–µ –Ω–∞–π–¥–µ–Ω–æ CadQuery –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –ø–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è")
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –∫–æ–¥–∞
            expressions = [line for line in cleaned_lines if '=' in line and not line.strip().startswith('#')]
            if expressions:
                last_expr = expressions[-1]
                var_name = last_expr.split('=')[0].strip()
                if var_name in local_vars:
                    cadquery_objects.append((var_name, local_vars[var_name]))
        
        if not cadquery_objects:
            logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–æ CadQuery –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –∫–æ–¥–µ" + (f" –∏–∑ —Ñ–∞–π–ª–∞ {filename}" if filename else ""))
            
            # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            if DEBUG_MODE:
                logger.debug("–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:")
                for var_name, var_value in local_vars.items():
                    logger.debug(f"  {var_name}: {type(var_value)}")
                
                logger.debug("–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:")
                logger.debug(cleaned_code[:500] + "..." if len(cleaned_code) > 500 else cleaned_code)
            
            return None
        else:
            # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π CadQuery –æ–±—ä–µ–∫—Ç (–æ–±—ã—á–Ω–æ —ç—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
            last_object = cadquery_objects[-1]
            logger.debug(f"–ù–∞–π–¥–µ–Ω CadQuery –æ–±—ä–µ–∫—Ç: {last_object[0]}")
            return last_object[1]
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ CadQuery –æ–±—ä–µ–∫—Ç–∞: {e}")
        if DEBUG_MODE:
            import traceback
            traceback.print_exc()
        return None

def py_file_to_mesh_and_brep_files(py_path, mesh_path, brep_path):
    """
    –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç CadQuery –∫–æ–¥ –∏–∑ Python —Ñ–∞–π–ª–∞ –≤ 3D –º–æ–¥–µ–ª—å (STL –∏ STEP).
    
    –ß–∏—Ç–∞–µ—Ç Python —Ñ–∞–π–ª —Å CadQuery –∫–æ–¥–æ–º, –∏–∑–≤–ª–µ–∫–∞–µ—Ç CadQuery –æ–±—ä–µ–∫—Ç, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç
    –µ–≥–æ –≤ mesh –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤ STL –∏ STEP —Ñ–æ—Ä–º–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
    –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –∫ –≤—ã—á–∏—Å–ª–µ–Ω–∏—é –º–µ—Ç—Ä–∏–∫.
    
    –ü—Ä–æ—Ü–µ—Å—Å:
        1. –ß—Ç–µ–Ω–∏–µ Python —Ñ–∞–π–ª–∞ —Å CadQuery –∫–æ–¥–æ–º
        2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ CadQuery –æ–±—ä–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ extract_cadquery_object()
        3. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è compound –≤ trimesh mesh
        4. –≠–∫—Å–ø–æ—Ä—Ç mesh –≤ STL —Ñ–∞–π–ª
        5. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç compound –≤ STEP —Ñ–∞–π–ª
    
    Args:
        py_path (str): –ü—É—Ç—å –∫ Python —Ñ–∞–π–ª—É —Å CadQuery –∫–æ–¥–æ–º.
            –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π CadQuery –∫–æ–¥.
        mesh_path (str): –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è STL —Ñ–∞–π–ª–∞.
            –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏–ª–∏ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞ –∑–∞—Ä–∞–Ω–µ–µ.
        brep_path (str): –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è STEP —Ñ–∞–π–ª–∞.
            –≠–∫—Å–ø–æ—Ä—Ç –≤ STEP –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω –∏ –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –æ—à–∏–±–∫–æ–π –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
    
    Returns:
        bool: True –µ—Å–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, False –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
            –£—Å–ø–µ—à–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ STL —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—É—é –º–æ–¥–µ–ª—å.
    
    Raises:
        FileNotFoundError: –ï—Å–ª–∏ py_path –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        IOError: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∏–ª–∏ –∑–∞–ø–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    
    Note:
        –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ mesh (–º–∏–Ω–∏–º—É–º 3 –≥—Ä–∞–Ω–∏).
        –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ STEP –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ STL —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç logger –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∏ –æ—à–∏–±–æ–∫.
    
    Example:
        >>> success = py_file_to_mesh_and_brep_files(
        ...     py_path='/workspace/results/model.py',
        ...     mesh_path='/workspace/eval/model.stl',
        ...     brep_path='/workspace/eval/model.step'
        ... )
        >>> print(f"–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞: {success}")
    """
    try:
        with open(py_path, 'r', encoding='utf-8') as f:
            py_string = f.read()
        
        if not py_string.strip():
            logger.warning(f"–ü—É—Å—Ç–æ–π —Ñ–∞–π–ª: {py_path}")
            return False
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º CadQuery –æ–±—ä–µ–∫—Ç –∏–∑ –∫–æ–¥–∞
        cadquery_obj = extract_cadquery_object(py_string, os.path.basename(py_path))
        
        if cadquery_obj is None:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å CadQuery –æ–±—ä–µ–∫—Ç –∏–∑ {py_path}")
            return False
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ mesh
        try:
            compound = cadquery_obj.val()
            mesh = compound_to_mesh(compound)
            
            if mesh is None or len(mesh.faces) < 3:
                logger.warning(f"–ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –º–æ–¥–µ–ª—å –ø–æ—Å–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: {py_path}")
                return False
            
            # –≠–∫—Å–ø–æ—Ä—Ç –≤ STL
            mesh.export(mesh_path)
            
            # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —ç–∫—Å–ø–æ—Ä—Ç –≤ STEP
            try:
                cq.exporters.export(compound, brep_path, exportType='STEP')
            except Exception as e:
                logger.debug(f"–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ STEP: {e}")
            
            return True
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–∞ –≤ mesh: {e}")
            if DEBUG_MODE:
                import traceback
                traceback.print_exc()
            return False
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ {py_path}: {e}")
        return False

def py_file_to_mesh_and_brep_files_safe(py_path, mesh_path, brep_path, timeout=5):
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è CadQuery –∫–æ–¥–∞ –≤ 3D –º–æ–¥–µ–ª—å —Å —Ç–∞–π–º–∞—É—Ç–æ–º.
    
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
    –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –∑–∞–≤–∏—Å–∞–Ω–∏–π –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç
    –∏–∑–æ–ª—è—Ü–∏—é –æ—à–∏–±–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞.
    
    –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ Python —Å–∫—Ä–∏–ø—Ç–∞ —Å –≤—ã–∑–æ–≤–æ–º py_file_to_mesh_and_brep_files()
        2. –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ —á–µ—Ä–µ–∑ subprocess.run()
        3. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    
    Args:
        py_path (str): –ü—É—Ç—å –∫ Python —Ñ–∞–π–ª—É —Å CadQuery –∫–æ–¥–æ–º.
        mesh_path (str): –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è STL —Ñ–∞–π–ª–∞.
        brep_path (str): –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è STEP —Ñ–∞–π–ª–∞.
        timeout (int, optional): –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö.
            –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –∑–∞ —ç—Ç–æ –≤—Ä–µ–º—è, –æ–Ω –±—É–¥–µ—Ç –ø—Ä–µ—Ä–≤–∞–Ω.
            –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 —Å–µ–∫—É–Ω–¥.
    
    Returns:
        bool: True –µ—Å–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, False –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç–∞.
    
    Raises:
        subprocess.TimeoutExpired: –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –∑–∞ timeout —Å–µ–∫—É–Ω–¥
            (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç False)
    
    Note:
        –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π Python —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç evaluate.py
        –∏ –≤—ã–∑—ã–≤–∞–µ—Ç py_file_to_mesh_and_brep_files(). –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–¥
        –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ, —á—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å multiprocessing.Pool.
        –í—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
    
    Example:
        >>> success = py_file_to_mesh_and_brep_files_safe(
        ...     py_path='/workspace/results/model.py',
        ...     mesh_path='/workspace/eval/model.stl',
        ...     brep_path='/workspace/eval/model.step',
        ...     timeout=10
        ... )
    """
    try:
        script_dir = os.path.dirname(os.path.abspath(__file__))
        script_content = f'''import sys
import os
import json
sys.path.insert(0, r"{script_dir}")
from evaluate import py_file_to_mesh_and_brep_files, DEBUG_MODE
DEBUG_MODE = {DEBUG_MODE}
result = py_file_to_mesh_and_brep_files(r"{py_path}", r"{mesh_path}", r"{brep_path}")
sys.exit(0 if result else 1)
'''
        
        with tempfile.NamedTemporaryFile(mode='w', delete=False, suffix='.py', encoding='utf-8') as f:
            f.write(script_content)
            script_path = f.name
        
        try:
            result = subprocess.run(
                [sys.executable, script_path],
                timeout=timeout,
                capture_output=True,
                text=True,
                cwd=script_dir
            )
            
            if result.returncode != 0:
                logger.warning(f"–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π –¥–ª—è {py_path}")
                if DEBUG_MODE:
                    logger.debug(f"STDOUT: {result.stdout}")
                    logger.debug(f"STDERR: {result.stderr}")
                return False
            
            return True
            
        except subprocess.TimeoutExpired:
            logger.warning(f'–¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: {py_path} (>{timeout} —Å–µ–∫)')
            return False
        except Exception as e:
            logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å–∞: {e}')
            return False
        finally:
            try:
                os.unlink(script_path)
            except:
                pass
                
    except Exception as e:
        logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ {py_path}: {e}')
        return False

def normalize_mesh(mesh: 'trimesh.Trimesh') -> 'trimesh.Trimesh | None':
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç mesh –≤ –µ–¥–∏–Ω–∏—á–Ω—ã–π –∫—É–± —Å —Ü–µ–Ω—Ç—Ä–æ–º –≤ –Ω–∞—á–∞–ª–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç.
    
    –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ mesh –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–≥–æ
    –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏—Ö –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∏ –ø–æ–ª–æ–∂–µ–Ω–∏—è.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º –º–µ—Ç—Ä–∏–∫ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π.
    
    –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–æ–∏–¥–∞ mesh (—Å—Ä–µ–¥–Ω—è—è —Ç–æ—á–∫–∞ bounding box)
        2. –ü–µ—Ä–µ–≤–æ–¥ mesh —Ç–∞–∫, —á—Ç–æ–±—ã —Ü–µ–Ω—Ç—Ä–æ–∏–¥ –±—ã–ª –≤ –Ω–∞—á–∞–ª–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        3. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–∫, —á—Ç–æ–±—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±—ã–ª —Ä–∞–≤–µ–Ω 1
    
    Args:
        mesh (trimesh.Trimesh): –ò—Å—Ö–æ–¥–Ω—ã–π mesh –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏.
            –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω–æ–π 3D –º–æ–¥–µ–ª—å—é —Å –≤–µ—Ä—à–∏–Ω–∞–º–∏ –∏ –≥—Ä–∞–Ω—è–º–∏.
    
    Returns:
        trimesh.Trimesh: –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π mesh —Å —Ü–µ–Ω—Ç—Ä–æ–º –≤ (0, 0, 0) –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º
            —Ä–∞–∑–º–µ—Ä–æ–º 1. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ø–∏—é –∏—Å—Ö–æ–¥–Ω–æ–≥–æ mesh, –∏—Å—Ö–æ–¥–Ω—ã–π –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è.
            –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
    
    Raises:
        ValueError: –ï—Å–ª–∏ mesh –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
        AttributeError: –ï—Å–ª–∏ mesh –Ω–µ –∏–º–µ–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤
    
    Note:
        –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç –∫–æ–ø–∏—é mesh –ø–µ—Ä–µ–¥ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π, –∏—Å—Ö–æ–¥–Ω—ã–π mesh –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è.
        –ï—Å–ª–∏ max_extent —Ä–∞–≤–µ–Ω 0 (–≤—ã—Ä–æ–∂–¥–µ–Ω–Ω—ã–π mesh), –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.
    
    Example:
        >>> import trimesh
        >>> mesh = trimesh.load('model.stl')
        >>> normalized = normalize_mesh(mesh)
        >>> print(f"–ì—Ä–∞–Ω–∏—Ü—ã: {normalized.bounds}")
        [[-0.5, -0.5, -0.5], [0.5, 0.5, 0.5]]
    """
    try:
        mesh_copy = mesh.copy()
        
        # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
        centroid = (mesh_copy.bounds[0] + mesh_copy.bounds[1]) / 2.0
        mesh_copy.apply_translation(-centroid)
        
        # –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –µ–¥–∏–Ω–∏—á–Ω–æ–º—É –∫—É–±—É
        max_extent = max(mesh_copy.extents)
        if max_extent > 0:
            mesh_copy.apply_scale(1.0 / max_extent)
        
        return mesh_copy
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ mesh: {e}")
        return None

def compute_chamfer_distance(gt_mesh: 'trimesh.Trimesh', pred_mesh: 'trimesh.Trimesh', 
                              n_points: int = 8192) -> float | None:
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç Chamfer Distance –º–µ–∂–¥—É –¥–≤—É–º—è 3D –º–æ–¥–µ–ª—è–º–∏.
    
    Chamfer Distance - —ç—Ç–æ –º–µ—Ç—Ä–∏–∫–∞ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ 3D –º–æ–¥–µ–ª–µ–π.
    –û–Ω–∞ –∏–∑–º–µ—Ä—è–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏
    –¥–æ –±–ª–∏–∂–∞–π—à–µ–π —Ç–æ—á–∫–∏ –¥—Ä—É–≥–æ–π –º–æ–¥–µ–ª–∏. –ú–µ–Ω—å—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–∑–Ω–∞—á–∞–µ—Ç –ª—É—á—à–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ.
    
    –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–µ–∏—Ö –º–æ–¥–µ–ª–µ–π –¥–æ –µ–¥–∏–Ω–∏—á–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        2. –°—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ n_points —Ç–æ—á–µ–∫ —Å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
        3. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ KD-–¥–µ—Ä–µ–≤—å–µ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –±–ª–∏–∂–∞–π—à–∏—Ö —Ç–æ—á–µ–∫
        4. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –¥–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π –∏ –∏—Ö —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ
    
    Args:
        gt_mesh (trimesh.Trimesh): Ground truth mesh (—ç—Ç–∞–ª–æ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å).
            –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω–æ–π 3D –º–æ–¥–µ–ª—å—é —Å –≤–µ—Ä—à–∏–Ω–∞–º–∏ –∏ –≥—Ä–∞–Ω—è–º–∏.
        pred_mesh (trimesh.Trimesh): –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–π mesh (—Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–¥–µ–ª–∏).
            –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω–æ–π 3D –º–æ–¥–µ–ª—å—é —Å –≤–µ—Ä—à–∏–Ω–∞–º–∏ –∏ –≥—Ä–∞–Ω—è–º–∏.
        n_points (int, optional): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –¥–ª—è —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏.
            –ë–æ–ª—å—à–µ —Ç–æ—á–µ–∫ –¥–∞—é—Ç –±–æ–ª–µ–µ —Ç–æ—á–Ω—É—é –æ—Ü–µ–Ω–∫—É, –Ω–æ —Ç—Ä–µ–±—É—é—Ç –±–æ–ª—å—à–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π.
            –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 8192.
    
    Returns:
        float or None: Chamfer Distance –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö. –ú–µ–Ω—å—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–∑–Ω–∞—á–∞–µ—Ç
            –ª—É—á—à–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–æ–¥–µ–ª–µ–π. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
    
    Raises:
        ValueError: –ï—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ mesh –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
        RuntimeError: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
    
    Note:
        –û–±–µ –º–æ–¥–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º –º–µ—Ç—Ä–∏–∫–∏
        –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞: —Å—Ä–µ–¥–Ω–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π –æ—Ç GT –∫ Pred
        –∏ –æ—Ç Pred –∫ GT.
    
    Example:
        >>> import trimesh
        >>> gt = trimesh.load('ground_truth.stl')
        >>> pred = trimesh.load('predicted.stl')
        >>> distance = compute_chamfer_distance(gt, pred, n_points=8192)
        >>> print(f"Chamfer Distance: {distance:.4f} –º–º")
        Chamfer Distance: 0.1234 –º–º
    """
    try:
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π
        pred_mesh_norm = normalize_mesh(pred_mesh)
        gt_mesh_norm = normalize_mesh(gt_mesh)
        
        if pred_mesh_norm is None or gt_mesh_norm is None:
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–¥–Ω—É –∏–∑ –º–æ–¥–µ–ª–µ–π")
            return None
        
        # –°—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—á–µ–∫
        try:
            gt_points, _ = trimesh.sample.sample_surface(gt_mesh_norm, n_points)
            pred_points, _ = trimesh.sample.sample_surface(pred_mesh_norm, n_points)
        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–æ—á–µ–∫: {e}")
            return None
        
        # –í—ã—á–∏—Å–ª–µ–Ω–∏–µ Chamfer Distance —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º KD-–¥–µ—Ä–µ–≤—å–µ–≤ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
        # KD-–¥–µ—Ä–µ–≤–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ —Ç–æ—á–∫–∏ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ–±–æ—Ä–∞
        
        # –°—Ç—Ä–æ–∏–º KD-–¥–µ—Ä–µ–≤—å—è –¥–ª—è –æ–±–µ–∏—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –±–ª–∏–∂–∞–π—à–∏—Ö —Ç–æ—á–µ–∫
        gt_tree = cKDTree(gt_points)
        pred_tree = cKDTree(pred_points)
        
        # –í—ã—á–∏—Å–ª—è–µ–º –¥–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è:
        # 1. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ pred –¥–æ –±–ª–∏–∂–∞–π—à–µ–π —Ç–æ—á–∫–∏ gt
        gt_distances, _ = gt_tree.query(pred_points, k=1)
        # 2. –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ gt –¥–æ –±–ª–∏–∂–∞–π—à–µ–π —Ç–æ—á–∫–∏ pred
        pred_distances, _ = pred_tree.query(gt_points, k=1)
        
        # Chamfer Distance = —Å—Ä–µ–¥–Ω–µ–µ –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –æ–±–æ–∏—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö
        # –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ—Å—Ç—å –º–µ—Ç—Ä–∏–∫–∏
        chamfer_distance = np.mean(np.square(gt_distances)) + np.mean(np.square(pred_distances))
        return chamfer_distance
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ Chamfer Distance: {e}")
        return None

def compute_iou_point_based(gt_mesh, pred_mesh, n_points=50000):
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç Intersection over Union (IoU) –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ—á–µ—á–Ω–æ–≥–æ –æ–±–ª–∞–∫–∞.
    
    IoU - —ç—Ç–æ –º–µ—Ç—Ä–∏–∫–∞ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è 3D –º–æ–¥–µ–ª—è–º–∏.
    –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –æ–±—ä–µ–º–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∫ –æ–±—ä–µ–º—É –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π.
    –ó–Ω–∞—á–µ–Ω–∏—è –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, 1], –≥–¥–µ 1 –æ–∑–Ω–∞—á–∞–µ—Ç –ø–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ.
    
    –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–µ–∏—Ö –º–æ–¥–µ–ª–µ–π –¥–æ –µ–¥–∏–Ω–∏—á–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–æ—Ç–Ω–æ–≥–æ —Ç–æ—á–µ—á–Ω–æ–≥–æ –æ–±–ª–∞–∫–∞ –≤–Ω—É—Ç—Ä–∏ bounding box –æ–±–µ–∏—Ö –º–æ–¥–µ–ª–µ–π
        3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –Ω–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
        4. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ IoU –∫–∞–∫ |intersection| / |union|
    
    Args:
        gt_mesh (trimesh.Trimesh): Ground truth mesh (—ç—Ç–∞–ª–æ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å).
            –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω–æ–π 3D –º–æ–¥–µ–ª—å—é —Å –≤–µ—Ä—à–∏–Ω–∞–º–∏ –∏ –≥—Ä–∞–Ω—è–º–∏.
        pred_mesh (trimesh.Trimesh): –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–π mesh (—Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–¥–µ–ª–∏).
            –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω–æ–π 3D –º–æ–¥–µ–ª—å—é —Å –≤–µ—Ä—à–∏–Ω–∞–º–∏ –∏ –≥—Ä–∞–Ω—è–º–∏.
        n_points (int, optional): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –æ–±—ä–µ–º–∞.
            –ë–æ–ª—å—à–µ —Ç–æ—á–µ–∫ –¥–∞—é—Ç –±–æ–ª–µ–µ —Ç–æ—á–Ω—É—é –æ—Ü–µ–Ω–∫—É, –Ω–æ —Ç—Ä–µ–±—É—é—Ç –±–æ–ª—å—à–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π.
            –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 50000.
    
    Returns:
        float or None: IoU –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, 1]. 1 –æ–∑–Ω–∞—á–∞–µ—Ç –ø–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ,
            0 –æ–∑–Ω–∞—á–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
    
    Raises:
        ValueError: –ï—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ mesh –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
        RuntimeError: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ—á–µ–∫
    
    Note:
        –ú–µ—Ç–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—é –æ–±—ä–µ–º–∞ —á–µ—Ä–µ–∑ –ø–ª–æ—Ç–Ω–æ–µ —Ç–æ—á–µ—á–Ω–æ–µ –æ–±–ª–∞–∫–æ.
        –¢–æ—á–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç n_points: –±–æ–ª—å—à–µ —Ç–æ—á–µ–∫ = –≤—ã—à–µ —Ç–æ—á–Ω–æ—Å—Ç—å, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ.
        –û–±–µ –º–æ–¥–µ–ª–∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.
    
    Example:
        >>> import trimesh
        >>> gt = trimesh.load('ground_truth.stl')
        >>> pred = trimesh.load('predicted.stl')
        >>> iou = compute_iou_point_based(gt, pred, n_points=50000)
        >>> print(f"IoU: {iou:.4f}")
        IoU: 0.8567
    """
    try:
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π
        pred_mesh_norm = normalize_mesh(pred_mesh)
        gt_mesh_norm = normalize_mesh(gt_mesh)
        
        if pred_mesh_norm is None or gt_mesh_norm is None:
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–¥–Ω—É –∏–∑ –º–æ–¥–µ–ª–µ–π –¥–ª—è IoU")
            return 0.0
        
        # –ü–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞—Ç—å –º–æ–¥–µ–ª–∏ –≤–æ–¥–æ–Ω–µ–ø—Ä–æ–Ω–∏—Ü–∞–µ–º—ã–º–∏ (watertight)
        # –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –æ–±—ä–µ–º–∞ —á–µ—Ä–µ–∑ contains()
        # Watertight –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ mesh –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã—Ç –±–µ–∑ –¥—ã—Ä
        for mesh in [gt_mesh_norm, pred_mesh_norm]:
            if not mesh.is_watertight:
                try:
                    # –ó–∞–ø–æ–ª–Ω—è–µ–º –¥—ã—Ä—ã –≤ mesh
                    trimesh.repair.fill_holes(mesh)
                    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ—Ä–º–∞–ª–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –≥—Ä–∞–Ω–µ–π
                    trimesh.repair.fix_normals(mesh)
                    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –≤–µ—Ä—à–∏–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä–∞–Ω–µ–π
                    trimesh.repair.fix_winding(mesh)
                except Exception as e:
                    logger.debug(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å mesh: {e}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞: –µ—Å–ª–∏ –º–æ–¥–µ–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ watertight, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥
        if not (gt_mesh_norm.is_watertight and pred_mesh_norm.is_watertight):
            logger.debug("–ú–æ–¥–µ–ª–∏ –Ω–µ watertight –ø–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ IoU")
            return compute_iou_bounding_box(gt_mesh_norm, pred_mesh_norm)
        
        # –°–æ–∑–¥–∞–µ–º –æ–±—â–∏–π –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏–π –±–æ–∫—Å, –æ—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–π –æ–±–µ –º–æ–¥–µ–ª–∏
        # –≠—Ç–æ –æ–±–ª–∞—Å—Ç—å, –≤ –∫–æ—Ç–æ—Ä–æ–π –º—ã –±—É–¥–µ–º —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–∫–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –æ–±—ä–µ–º–∞
        combined_bounds = np.array([
            np.minimum(gt_mesh_norm.bounds[0], pred_mesh_norm.bounds[0]),
            np.maximum(gt_mesh_norm.bounds[1], pred_mesh_norm.bounds[1])
        ])
        
        # –°—ç–º–ø–ª–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Ç–æ—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ –æ–±—â–µ–≥–æ bounding box
        # –ë–æ–ª—å—à–µ —Ç–æ—á–µ–∫ = –≤—ã—à–µ —Ç–æ—á–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–∫–∏ –æ–±—ä–µ–º–∞, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ
        points = np.random.uniform(
            combined_bounds[0],
            combined_bounds[1],
            (n_points, 3)
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ —Ç–æ—á–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
        # contains() —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è watertight mesh
        try:
            gt_inside = gt_mesh_norm.contains(points)
            pred_inside = pred_mesh_norm.contains(points)
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ—á–µ–∫ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–µ–ª–µ–π: {e}")
            return compute_iou_bounding_box(gt_mesh_norm, pred_mesh_norm)
        
        # –í—ã—á–∏—Å–ª—è–µ–º IoU –∫–∞–∫ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∫ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é
        # intersection: —Ç–æ—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –æ–±–µ–∏—Ö –º–æ–¥–µ–ª–µ–π
        intersection = np.logical_and(gt_inside, pred_inside).sum()
        # union: —Ç–æ—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏
        union = np.logical_or(gt_inside, pred_inside).sum()
        
        if union > 0:
            return intersection / union
        return 0.0
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ IoU: {e}")
        return 0.0

def compute_iou_bounding_box(gt_mesh, pred_mesh, resolution=30):
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç Intersection over Union (IoU) –Ω–∞ –æ—Å–Ω–æ–≤–µ bounding box.
    
    –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è IoU, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ
    bounding boxes –º–æ–¥–µ–ª–µ–π –≤–º–µ—Å—Ç–æ —Ç–æ—á–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –æ–±—ä–µ–º–æ–≤. –ë—ã—Å—Ç—Ä–µ–µ —á–µ–º
    point-based –º–µ—Ç–æ–¥, –Ω–æ –º–µ–Ω–µ–µ —Ç–æ—á–Ω—ã–π.
    
    –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–µ–∏—Ö –º–æ–¥–µ–ª–µ–π –¥–æ –µ–¥–∏–Ω–∏—á–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        2. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ bounding boxes –¥–ª—è –æ–±–µ–∏—Ö –º–æ–¥–µ–ª–µ–π
        3. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è bounding boxes
        4. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ IoU –∫–∞–∫ volume(intersection) / volume(union)
    
    Args:
        gt_mesh (trimesh.Trimesh): Ground truth mesh (—ç—Ç–∞–ª–æ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å).
            –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω–æ–π 3D –º–æ–¥–µ–ª—å—é —Å –≤–µ—Ä—à–∏–Ω–∞–º–∏ –∏ –≥—Ä–∞–Ω—è–º–∏.
        pred_mesh (trimesh.Trimesh): –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–π mesh (—Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–¥–µ–ª–∏).
            –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω–æ–π 3D –º–æ–¥–µ–ª—å—é —Å –≤–µ—Ä—à–∏–Ω–∞–º–∏ –∏ –≥—Ä–∞–Ω—è–º–∏.
        resolution (int, optional): –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏ bounding box.
            –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏–∏ –æ–±—ä–µ–º–∞. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 30.
    
    Returns:
        float or None: IoU –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, 1]. 1 –æ–∑–Ω–∞—á–∞–µ—Ç –ø–æ–ª–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
            bounding boxes, 0 –æ–∑–Ω–∞—á–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è.
            –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
    
    Raises:
        ValueError: –ï—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ mesh –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
    
    Note:
        –ú–µ—Ç–æ–¥ –±—ã—Å—Ç—Ä–µ–µ —á–µ–º point-based IoU, –Ω–æ –º–µ–Ω–µ–µ —Ç–æ—á–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
        —Ç–æ–ª—å–∫–æ bounding boxes –≤–º–µ—Å—Ç–æ —Ç–æ—á–Ω–æ–π –≥–µ–æ–º–µ—Ç—Ä–∏–∏. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π
        –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞.
    
    Example:
        >>> import trimesh
        >>> gt = trimesh.load('ground_truth.stl')
        >>> pred = trimesh.load('predicted.stl')
        >>> iou = compute_iou_bounding_box(gt, pred, resolution=30)
        >>> print(f"IoU (BB): {iou:.4f}")
        IoU (BB): 0.9234
    """
    """–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ IoU –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏—Ö –±–æ–∫—Å–æ–≤"""
    try:
        # –°–æ–∑–¥–∞–µ–º –æ–±—â—É—é –≤–æ–∫—Å–µ–ª—å–Ω—É—é —Å–µ—Ç–∫—É
        bounds = np.array([
            np.minimum(gt_mesh.bounds[0], pred_mesh.bounds[0]),
            np.maximum(gt_mesh.bounds[1], pred_mesh.bounds[1])
        ])
        
        # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        resolution = min(resolution, 50)
        
        # –°–æ–∑–¥–∞–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω—É—é —Å–µ—Ç–∫—É —Ç–æ—á–µ–∫
        x = np.linspace(bounds[0][0], bounds[1][0], resolution)
        y = np.linspace(bounds[0][1], bounds[1][1], resolution)
        z = np.linspace(bounds[0][2], bounds[1][2], resolution)
        
        # –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É —Ç–æ—á–µ–∫
        xx, yy, zz = np.meshgrid(x, y, z, indexing='ij')
        points = np.vstack([xx.ravel(), yy.ravel(), zz.ravel()]).T
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏—Ö –±–æ–∫—Å–æ–≤
        gt_min, gt_max = gt_mesh.bounds
        pred_min, pred_max = pred_mesh.bounds
        
        gt_inside = np.all((points >= gt_min) & (points <= gt_max), axis=1)
        pred_inside = np.all((points >= pred_min) & (points <= pred_max), axis=1)
        
        # –í—ã—á–∏—Å–ª—è–µ–º IoU
        intersection = np.logical_and(gt_inside, pred_inside).sum()
        union = np.logical_or(gt_inside, pred_inside).sum()
        
        if union > 0:
            return intersection / union
        return 0.0
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ IoU bounding box: {e}")
        return 0.0

def check_model_file(py_path):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å CadQuery –∫–æ–¥–∞ –≤ —Ñ–∞–π–ª–µ.
    
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –±–∞–∑–æ–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è CadQuery –æ–±—ä–µ–∫—Ç–∞
    –∏–∑ —Ñ–∞–π–ª–∞ –±–µ–∑ –ø–æ–ª–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ mesh. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    –ø–µ—Ä–µ–¥ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º –º–µ—Ç—Ä–∏–∫.
    
    Args:
        py_path (str): –ü—É—Ç—å –∫ Python —Ñ–∞–π–ª—É —Å CadQuery –∫–æ–¥–æ–º.
            –î–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –±—ã—Ç—å —á–∏—Ç–∞–µ–º—ã–º.
    
    Returns:
        bool: True –µ—Å–ª–∏ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–π CadQuery –∫–æ–¥ –∏ –æ–±—ä–µ–∫—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω,
            False –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ.
    
    Raises:
        FileNotFoundError: –ï—Å–ª–∏ py_path –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        IOError: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª
    
    Note:
        –§—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é –≤ mesh, —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å
        –∏–∑–≤–ª–µ—á–µ–Ω–∏—è CadQuery –æ–±—ä–µ–∫—Ç–∞. –≠—Ç–æ –±—ã—Å—Ç—Ä–µ–µ —á–µ–º –ø–æ–ª–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è, –Ω–æ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç,
        —á—Ç–æ –∫–æ–¥ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.
    
    Example:
        >>> is_valid = check_model_file('/workspace/results/model.py')
        >>> print(f"–§–∞–π–ª –≤–∞–ª–∏–¥–µ–Ω: {is_valid}")
    """
    try:
        with open(py_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        logger.info(f"\nüîç –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞: {os.path.basename(py_path)}")
        logger.info(f"  –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(content)} –±–∞–π—Ç")
        
        # –ê–Ω–∞–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        has_import_cadquery = any('import cadquery' in line or 'import cq' in line or 'from cadquery' in line 
                                 for line in content.split('\n'))
        has_cq_object = any('cq.' in line or 'cadquery.' in line for line in content.split('\n'))
        has_show_object = any('show_object' in line or '.show(' in line for line in content.split('\n'))
        
        logger.info(f"  –ò–º–ø–æ—Ä—Ç CadQuery: {'‚úÖ' if has_import_cadquery else '‚ùå'}")
        logger.info(f"  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ cq.: {'‚úÖ' if has_cq_object else '‚ùå'}")
        logger.info(f"  show_object(): {'‚úÖ' if has_show_object else '‚ùå'}")
        
        # –ü–æ–∏—Å–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å CadQuery –æ–±—ä–µ–∫—Ç—ã
        variable_pattern = r'(\w+)\s*=\s*[^#]+'
        variables = re.findall(variable_pattern, content)
        unique_vars = sorted(set(var for var in variables if len(var) > 1))
        
        logger.info(f"  –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: {', '.join(unique_vars[:10]) + ('...' if len(unique_vars) > 10 else '')}")
        
        # –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å –æ–±—ä–µ–∫—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if has_cq_object:
            logger.info("  üîÑ –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è CadQuery –æ–±—ä–µ–∫—Ç–∞...")
            test_obj = extract_cadquery_object(content, os.path.basename(py_path))
            if test_obj is not None:
                logger.info("  ‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω CadQuery –æ–±—ä–µ–∫—Ç")
                return True
            else:
                logger.warning("  ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –æ–±—ä–µ–∫—Ç")
                return False
        
        return has_cq_object
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ñ–∞–π–ª–∞ {py_path}: {e}")
        return False

def run_cd_single(py_file_name, pred_py_path, pred_mesh_path, pred_brep_path, gt_mesh_path, n_points):
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (Chamfer Distance –∏ IoU).
    
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–∏–Ω –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–π CadQuery —Ñ–∞–π–ª: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –µ–≥–æ –≤ mesh,
    –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π ground truth mesh –∏ –≤—ã—á–∏—Å–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ worker —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ Pool.
    
    –ü—Ä–æ—Ü–µ—Å—Å:
        1. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è CadQuery –∫–æ–¥–∞ –≤ mesh (STL –∏ STEP)
        2. –ó–∞–≥—Ä—É–∑–∫–∞ ground truth mesh
        3. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ Chamfer Distance
        4. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ IoU (point-based –∏ bounding box)
        5. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏
    
    Args:
        py_file_name (str): –ò–º—è Python —Ñ–∞–π–ª–∞ —Å CadQuery –∫–æ–¥–æ–º (–±–µ–∑ –ø—É—Ç–∏).
            –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö.
        pred_py_path (str): –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–º–∏ Python —Ñ–∞–π–ª–∞–º–∏.
        pred_mesh_path (str): –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö mesh —Ñ–∞–π–ª–æ–≤.
        pred_brep_path (str): –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è STEP —Ñ–∞–π–ª–æ–≤.
        gt_mesh_path (str): –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å ground truth mesh —Ñ–∞–π–ª–∞–º–∏.
        n_points (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è Chamfer Distance.
            –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–∫–∂–µ –¥–ª—è point-based IoU.
    
    Returns:
        dict: –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π:
            - 'file_name' (str): –ò–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
            - 'chamfer_distance' (float or None): Chamfer Distance –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö
            - 'iou_point_based' (float or None): IoU –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ—á–µ—á–Ω–æ–≥–æ –æ–±–ª–∞–∫–∞
            - 'iou_bounding_box' (float or None): IoU –Ω–∞ –æ—Å–Ω–æ–≤–µ bounding box
            - 'is_valid' (bool): –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
            - 'error' (str, optional): –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞
    
    Raises:
        FileNotFoundError: –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã
        RuntimeError: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é –∏–ª–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
    
    Note:
        –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ multiprocessing.Pool.
        –í—Å–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ —Å–ª–æ–≤–∞—Ä–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç logger –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∏ –æ—à–∏–±–æ–∫.
    
    Example:
        >>> result = run_cd_single(
        ...     py_file_name='model+0.py',
        ...     pred_py_path='/workspace/results',
        ...     pred_mesh_path='/workspace/eval/meshes',
        ...     pred_brep_path='/workspace/eval/breps',
        ...     gt_mesh_path='/workspace/data/meshes',
        ...     n_points=8192
        ... )
        >>> print(f"Chamfer Distance: {result['chamfer_distance']}")
    """
    try:
        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å GT
        base_name = os.path.splitext(py_file_name)[0]
        # –£–¥–∞–ª—è–µ–º —Å—É—Ñ—Ñ–∏–∫—Å—ã –≤—Ä–æ–¥–µ _001, +0, –∏ —Ç.–¥.
        eval_file_name = re.sub(r'(_\d+|\+\d+)$', '', base_name)
        
        py_path = os.path.join(pred_py_path, py_file_name)
        mesh_path = os.path.join(pred_mesh_path, base_name + '.stl')
        brep_path = os.path.join(pred_brep_path, base_name + '.step')
        
        if not os.path.exists(py_path):
            logger.warning(f"–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {py_path}")
            return {'file_name': eval_file_name, 'id': py_file_name, 'cd': None, 'iou': None, 'valid': False}
        
        # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
        success = py_file_to_mesh_and_brep_files_safe(py_path, mesh_path, brep_path)
        
        if not success or not os.path.exists(mesh_path):
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å {py_file_name}")
            return {'file_name': eval_file_name, 'id': py_file_name, 'cd': None, 'iou': None, 'valid': False}
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        try:
            pred_mesh = trimesh.load_mesh(mesh_path)
        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ mesh {mesh_path}: {e}")
            return {'file_name': eval_file_name, 'id': py_file_name, 'cd': None, 'iou': None, 'valid': False}
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        if len(pred_mesh.faces) < 3:
            logger.warning(f"–ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –º–æ–¥–µ–ª—å (–º–µ–Ω—å—à–µ 3 –≥—Ä–∞–Ω–µ–π): {mesh_path}")
            return {'file_name': eval_file_name, 'id': py_file_name, 'cd': None, 'iou': None, 'valid': False}
        
        # –ü–æ–∏—Å–∫ ground truth —Ñ–∞–π–ª–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏
        gt_extensions = ['.stl', '.obj', '.ply', '.off']
        gt_file_path = None
        
        for ext in gt_extensions:
            test_path = os.path.join(gt_mesh_path, eval_file_name + ext)
            if os.path.exists(test_path):
                gt_file_path = test_path
                break
        
        if gt_file_path is None:
            # –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ñ–∞–π–ª —Å –ø–æ—Ö–æ–∂–∏–º –∏–º–µ–Ω–µ–º
            possible_names = [
                eval_file_name,
                os.path.basename(eval_file_name),
                re.sub(r'[^a-zA-Z0-9]', '_', eval_file_name)
            ]
            
            for name in possible_names:
                for ext in gt_extensions:
                    test_path = os.path.join(gt_mesh_path, name + ext)
                    if os.path.exists(test_path):
                        gt_file_path = test_path
                        break
                if gt_file_path:
                    break
        
        if gt_file_path is None:
            logger.warning(f"GT —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è: {eval_file_name}")
            return {'file_name': eval_file_name, 'id': py_file_name, 'cd': None, 'iou': None, 'valid': False}
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ ground truth –º–æ–¥–µ–ª–∏
        try:
            gt_mesh = trimesh.load_mesh(gt_file_path)
        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ GT mesh {gt_file_path}: {e}")
            return {'file_name': eval_file_name, 'id': py_file_name, 'cd': None, 'iou': None, 'valid': False}
        
        if len(gt_mesh.faces) < 3:
            logger.warning(f"–ù–µ–≤–∞–ª–∏–¥–Ω–∞—è GT –º–æ–¥–µ–ª—å: {gt_file_path}")
            return {'file_name': eval_file_name, 'id': py_file_name, 'cd': None, 'iou': None, 'valid': False}
        
        # –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
        cd = compute_chamfer_distance(gt_mesh.copy(), pred_mesh.copy(), n_points)
        
        if cd is None:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å CD –¥–ª—è {py_file_name}")
            return {'file_name': eval_file_name, 'id': py_file_name, 'cd': None, 'iou': None, 'valid': False}
        
        iou = compute_iou_point_based(gt_mesh.copy(), pred_mesh.copy())
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        logger.info(f"‚úÖ {py_file_name}: CD={cd*1000:.4f} –º–º, IoU={iou:.4f}, "
                    f"Faces={len(pred_mesh.faces)}, Valid=True")
        
        return {
            'file_name': eval_file_name, 
            'id': py_file_name, 
            'cd': cd, 
            'iou': iou, 
            'valid': True,
            'gt_path': gt_file_path,
            'pred_path': mesh_path
        }
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ {py_file_name}: {e}")
        if DEBUG_MODE:
            import traceback
            traceback.print_exc()
        return {'file_name': eval_file_name if 'eval_file_name' in locals() else py_file_name, 
                'id': py_file_name, 
                'cd': None, 
                'iou': None, 
                'valid': False}

def analyze_results(results, pred_py_path):
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –∏ –≤—ã—á–∏—Å–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.
    
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∏ –≤—ã—á–∏—Å–ª—è–µ—Ç
    –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è, –º–µ–¥–∏–∞–Ω—ã, –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª–∏ –∏ –¥—Ä—É–≥–∏–µ –º–µ—Ç—Ä–∏–∫–∏.
    –¢–∞–∫–∂–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ–ª—é –≤–∞–ª–∏–¥–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π.
    
    Args:
        results (list): –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞.
            –ö–∞–∂–¥—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–ª—é—á–∏ –∏–∑ run_cd_single().
        pred_py_path (str): –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–º–∏ Python —Ñ–∞–π–ª–∞–º–∏.
            –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤.
    
    Returns:
        dict: –°–ª–æ–≤–∞—Ä—å —Å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π:
            - 'total_files' (int): –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            - 'valid_files' (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            - 'invalid_files' (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            - 'invalidity_ratio' (float): –î–æ–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ [0, 1]
            - 'chamfer_distances' (list): –°–ø–∏—Å–æ–∫ Chamfer Distance –∑–Ω–∞—á–µ–Ω–∏–π
            - 'iou_point_based' (list): –°–ø–∏—Å–æ–∫ IoU (point-based) –∑–Ω–∞—á–µ–Ω–∏–π
            - 'iou_bounding_box' (list): –°–ø–∏—Å–æ–∫ IoU (bounding box) –∑–Ω–∞—á–µ–Ω–∏–π
            - 'mean_chamfer' (float): –°—Ä–µ–¥–Ω–µ–µ Chamfer Distance
            - 'mean_iou_point' (float): –°—Ä–µ–¥–Ω–µ–µ IoU (point-based)
            - 'mean_iou_bb' (float): –°—Ä–µ–¥–Ω–µ–µ IoU (bounding box)
            - –ò –¥—Ä—É–≥–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
    
    Note:
        –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç None –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –º–µ—Ç—Ä–∏–∫ –ø–µ—Ä–µ–¥ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç numpy –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫ (mean, median, percentile).
    
    Example:
        >>> results = [run_cd_single(...) for ...]
        >>> stats = analyze_results(results, '/workspace/results')
        >>> print(f"–°—Ä–µ–¥–Ω–∏–π Chamfer Distance: {stats['mean_chamfer']:.4f}")
    """
    """–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
    logger.info("\n" + "="*70)
    logger.info("üîç –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –û–¶–ï–ù–ö–ò")
    logger.info("="*70)
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤–∞–ª–∏–¥–Ω—ã–º –º–æ–¥–µ–ª—è–º
    valid_results = [r for r in results if r['valid']]
    invalid_results = [r for r in results if not r['valid']]
    
    logger.info(f"üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
    logger.info(f"   –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: {len(results)}")
    logger.info(f"   –í–∞–ª–∏–¥–Ω—ã—Ö: {len(valid_results)} ({len(valid_results)/len(results)*100:.1f}%)")
    logger.info(f"   –ù–µ–≤–∞–ª–∏–¥–Ω—ã—Ö: {len(invalid_results)} ({len(invalid_results)/len(results)*100:.1f}%)")
    
    # –ê–Ω–∞–ª–∏–∑ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    if invalid_results:
        logger.info(f"\n‚ùå –ù–ï–í–ê–õ–ò–î–ù–´–ï –§–ê–ô–õ–´ ({len(invalid_results)}):")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        sample_size = min(5, len(invalid_results))
        for i, result in enumerate(invalid_results[:sample_size]):
            py_path = os.path.join(pred_py_path, result['id'])
            if os.path.exists(py_path):
                logger.info(f"   –ü—Ä–∏–º–µ—Ä {i+1}/{sample_size}: {result['id']}")
                check_model_file(py_path)
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º
    if valid_results:
        cd_values = [r['cd'] for r in valid_results if r['cd'] is not None and not np.isnan(r['cd'])]
        iou_values = [r['iou'] for r in valid_results if r['iou'] is not None and not np.isnan(r['iou'])]
        
        if cd_values:
            logger.info(f"\nüìè Chamfer Distance (CD):")
            logger.info(f"   –°—Ä–µ–¥–Ω–∏–π: {np.mean(cd_values)*1000:.4f} –º–º")
            logger.info(f"   –ú–µ–¥–∏–∞–Ω–Ω—ã–π: {np.median(cd_values)*1000:.4f} –º–º")
            logger.info(f"   Min: {np.min(cd_values)*1000:.4f} –º–º")
            logger.info(f"   Max: {np.max(cd_values)*1000:.4f} –º–º")
            logger.info(f"   Std: {np.std(cd_values)*1000:.4f} –º–º")
            logger.info(f"   –í—Å–µ–≥–æ –≤–∞–ª–∏–¥–Ω—ã—Ö CD: {len(cd_values)}")
        
        if iou_values:
            logger.info(f"\nüéØ IoU:")
            logger.info(f"   –°—Ä–µ–¥–Ω–∏–π: {np.mean(iou_values):.4f}")
            logger.info(f"   –ú–µ–¥–∏–∞–Ω–Ω—ã–π: {np.median(iou_values):.4f}")
            logger.info(f"   Min: {np.min(iou_values):.4f}")
            logger.info(f"   Max: {np.max(iou_values):.4f}")
            logger.info(f"   Std: {np.std(iou_values):.4f}")
            logger.info(f"   –í—Å–µ–≥–æ –≤–∞–ª–∏–¥–Ω—ã—Ö IoU: {len(iou_values)}")
            
            # –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ IoU
            if len(iou_values) > 0:
                logger.info(f"\nüìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ IoU:")
                bins = [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]
                hist, bin_edges = np.histogram(iou_values, bins=bins)
                
                for i in range(len(hist)):
                    if hist[i] > 0:
                        logger.info(f"   [{bin_edges[i]:.1f}-{bin_edges[i+1]:.1f}]: {hist[i]} —Ñ–∞–π–ª–æ–≤ ({hist[i]/len(iou_values)*100:.1f}%)")

def get_file_safe_base_name(filename: str) -> str:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –±–∞–∑–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ —Å—É—Ñ—Ñ–∏–∫—Å–æ–≤.
    
    –£–¥–∞–ª—è–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (.py, .stl) –∏ —Å—É—Ñ—Ñ–∏–∫—Å—ã –≤–∏–¥–∞ +0, +1, +2 –∏ —Ç.–¥.,
    –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å ground truth —Ñ–∞–π–ª–∞–º–∏.
    
    Args:
        filename (str): –ò–º—è —Ñ–∞–π–ª–∞ —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏ –∏ —Å—É—Ñ—Ñ–∏–∫—Å–∞–º–∏.
            –ù–∞–ø—Ä–∏–º–µ—Ä: 'model+0.py', 'model+1.stl', 'model.py'
    
    Returns:
        str: –ë–∞–∑–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ —Å—É—Ñ—Ñ–∏–∫—Å–æ–≤.
            –ù–∞–ø—Ä–∏–º–µ—Ä: 'model' –¥–ª—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã—à–µ.
    
    Example:
        >>> base_name = get_file_safe_base_name('model+0.py')
        >>> print(base_name)
        'model'
        >>> base_name = get_file_safe_base_name('model+1.stl')
        >>> print(base_name)
        'model'
    """
    base = os.path.splitext(filename)[0]
    # –£–¥–∞–ª—è–µ–º —á–∏—Å–ª–æ–≤—ã–µ —Å—É—Ñ—Ñ–∏–∫—Å—ã –≤ –∫–æ–Ω—Ü–µ
    base = re.sub(r'(_\d+|\+\d+|-\d+)$', '', base)
    # –£–¥–∞–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    base = re.sub(r'[^a-zA-Z0-9_\-]', '_', base)
    return base

def run(gt_mesh_path, pred_py_path, pred_eval_path, n_points=8192, num_workers=20, check_models=False, debug=False):
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ—Ü–µ–Ω–∫–∏ –º–æ–¥–µ–ª–µ–π –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º Chamfer Distance –∏ IoU.
    
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –º–æ–¥—É–ª—è, –∫–æ—Ç–æ—Ä–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –æ—Ü–µ–Ω–∫–∏:
    –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∏—Ö –≤ mesh, –≤—ã—á–∏—Å–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏
    –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è.
    
    –ü—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
        1. –ü–æ–∏—Å–∫ –≤—Å–µ—Ö Python —Ñ–∞–π–ª–æ–≤ –≤ pred_py_path
        2. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è mesh –∏ STEP —Ñ–∞–π–ª–æ–≤
        3. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ (–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫)
        4. –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ JSON —Ñ–∞–π–ª
    
    Args:
        gt_mesh_path (str): –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å ground truth mesh —Ñ–∞–π–ª–∞–º–∏ (STL).
            –î–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å STL —Ñ–∞–π–ª—ã —Å –∏–º–µ–Ω–∞–º–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º.
        pred_py_path (str): –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–º–∏ Python —Ñ–∞–π–ª–∞–º–∏ (CadQuery –∫–æ–¥).
            –î–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å .py —Ñ–∞–π–ª—ã —Å CadQuery –∫–æ–¥–æ–º.
        pred_eval_path (str): –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ü–µ–Ω–∫–∏.
            –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –í –Ω–µ–π –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã:
            - meshes/: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ STL —Ñ–∞–π–ª–∞–º–∏
            - breps/: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å STEP —Ñ–∞–π–ª–∞–º–∏
            - results.json: —Ñ–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫
        n_points (int, optional): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è Chamfer Distance.
            –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 8192.
        num_workers (int, optional): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.
            –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–µ—Ä CPU. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 20.
        check_models (bool, optional): –í—ã–ø–æ–ª–Ω—è—Ç—å –ª–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤.
            –ï—Å–ª–∏ True, –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é False.
        debug (bool, optional): –í–∫–ª—é—á–∏—Ç—å –ª–∏ —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
            –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é False.
    
    Returns:
        dict: –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –æ—Ü–µ–Ω–∫–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π:
            - 'metrics' (dict): –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ—Ç—Ä–∏–∫
            - 'results' (list): –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
            - 'summary' (dict): –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    
    Raises:
        FileNotFoundError: –ï—Å–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ gt_mesh_path –∏–ª–∏ pred_py_path –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        ValueError: –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        RuntimeError: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    
    Note:
        –§—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç multiprocessing.Pool –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç logger –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –æ—à–∏–±–æ–∫.
        –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
    
    Example:
        >>> results = run(
        ...     gt_mesh_path='/workspace/data/deepcad_test_mesh',
        ...     pred_py_path='/workspace/results/cadrille',
        ...     pred_eval_path='/workspace/results/cadrille_eval',
        ...     n_points=8192,
        ...     num_workers=20,
        ...     check_models=False,
        ...     debug=False
        ... )
        >>> print(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {results['summary']['total_files']}")
    """
    global DEBUG_MODE
    DEBUG_MODE = debug
    
    logger.info("="*70)
    logger.info("üöÄ –ù–ê–ß–ê–õ–û –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ô –û–¶–ï–ù–ö–ò –ú–û–î–ï–õ–ï–ô CAD")
    logger.info("="*70)
    logger.info(f"üìÅ GT –º–æ–¥–µ–ª–∏: {gt_mesh_path}")
    logger.info(f"üìÅ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è (Python): {pred_py_path}")
    logger.info(f"üìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ü–µ–Ω–∫–∏: {pred_eval_path}")
    logger.info(f"‚öôÔ∏è  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: n_points={n_points}, workers={num_workers}, debug={debug}")
    logger.info("="*70)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    for path_name, path in [('GT models', gt_mesh_path), ('Predictions', pred_py_path)]:
        if not os.path.exists(path):
            logger.error(f"‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {path}")
            return
    
    if check_models:
        logger.info("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –º–æ–¥–µ–ª–µ–π...")
        py_files = [f for f in os.listdir(pred_py_path) if f.endswith('.py')]
        sample_files = py_files[:3]  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 3 —Ñ–∞–π–ª–∞
        
        for py_file in sample_files:
            py_path = os.path.join(pred_py_path, py_file)
            check_model_file(py_path)
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    pred_mesh_path = os.path.join(pred_eval_path, 'meshes')
    pred_brep_path = os.path.join(pred_eval_path, 'breps')
    os.makedirs(pred_mesh_path, exist_ok=True)
    os.makedirs(pred_brep_path, exist_ok=True)
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
    py_file_names = [f for f in os.listdir(pred_py_path) if f.endswith('.py')]
    logger.info(f"üéØ –ù–∞–π–¥–µ–Ω–æ {len(py_file_names)} Python —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—Ü–µ–Ω–∫–∏")
    
    if not py_file_names:
        logger.error("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—Ü–µ–Ω–∫–∏!")
        return
    
    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    if debug and len(py_file_names) > 10:
        py_file_names = py_file_names[:10]
        logger.info(f"üîß –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã—Ö {len(py_file_names)} —Ñ–∞–π–ª–æ–≤")
    
    # –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
    logger.info("üìà –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫...")
    start_time = time.time()
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω—å—à–µ –≤–æ—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    actual_workers = min(num_workers, len(py_file_names)) if not debug else 1
    
    try:
        with Pool(actual_workers) as pool:
            results = list(tqdm(pool.imap(
                partial(
                    run_cd_single,
                    pred_py_path=pred_py_path,
                    pred_mesh_path=pred_mesh_path,
                    pred_brep_path=pred_brep_path,
                    gt_mesh_path=gt_mesh_path,
                    n_points=n_points),
                py_file_names), total=len(py_file_names)))
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ: {e}")
        logger.info("üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏...")
        results = []
        for py_file_name in tqdm(py_file_names):
            result = run_cd_single(
                py_file_name, 
                pred_py_path, 
                pred_mesh_path, 
                pred_brep_path, 
                gt_mesh_path, 
                n_points
            )
            results.append(result)
    
    elapsed = time.time() - start_time
    logger.info(f"‚úÖ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞ {elapsed:.2f} —Å–µ–∫—É–Ω–¥")
    
    # –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    analyze_results(results, pred_py_path)
    
    # –ê–≥—Ä–µ–≥–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫
    logger.info("\n" + "="*70)
    logger.info("üìà –ê–ì–†–ï–ì–ê–¶–ò–Ø –ò–¢–û–ì–û–í–´–• –†–ï–ó–£–õ–¨–¢–ê–¢–û–í")
    logger.info("="*70)
    
    metrics = defaultdict(lambda: defaultdict(list))
    valid_count = 0
    
    for result in results:
        file_name = result['file_name']
        
        if result['valid']:
            valid_count += 1
            if result['cd'] is not None and not np.isnan(result['cd']):
                metrics[file_name]['cd'].append(result['cd'])
                metrics[file_name]['cd_files'].append(result['id'])
            if result['iou'] is not None and not np.isnan(result['iou']):
                metrics[file_name]['iou'].append(result['iou'])
                metrics[file_name]['iou_files'].append(result['id'])
        else:
            metrics[file_name]  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    
    total_files = len(metrics)
    invalid_ratio = (total_files - valid_count) / total_files if total_files > 0 else 1.0
    
    logger.info(f"‚úÖ –í–∞–ª–∏–¥–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π: {valid_count}/{total_files} ({(1-invalid_ratio)*100:.1f}%)")
    logger.info(f"‚ùå Invalidity Ratio: {invalid_ratio*100:.1f}%")
    
    # –í—ã–±–æ—Ä –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
    cd_values, iou_values, best_names = [], [], []
    
    for file_name, file_metrics in metrics.items():
        if 'cd' in file_metrics and file_metrics['cd']:
            # –í—ã–±–∏—Ä–∞–µ–º –º–æ–¥–µ–ª—å —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º Chamfer Distance
            best_idx = np.argmin(file_metrics['cd'])
            best_cd = file_metrics['cd'][best_idx]
            best_file = file_metrics['cd_files'][best_idx]
            
            cd_values.append(best_cd)
            best_names.append(best_file)
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π IoU, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            if 'iou' in file_metrics and file_metrics['iou']:
                try:
                    iou_idx = file_metrics['iou_files'].index(best_file)
                    iou_values.append(file_metrics['iou'][iou_idx])
                except ValueError:
                    # –ï—Å–ª–∏ IoU –Ω–µ—Ç –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π
                    if file_metrics['iou']:
                        iou_values.append(max(file_metrics['iou']))
        elif 'iou' in file_metrics and file_metrics['iou']:
            # –ï—Å–ª–∏ –Ω–µ—Ç Chamfer Distance, –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π IoU
            best_idx = np.argmax(file_metrics['iou'])
            best_iou = file_metrics['iou'][best_idx]
            # best_file = file_metrics['iou_files'][best_idx]
            iou_values.append(best_iou)
    
    # –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫
    logger.info("\n" + "="*70)
    logger.info("üèÜ –ò–¢–û–ì–û–í–´–ï –ú–ï–¢–†–ò–ö–ò –û–¶–ï–ù–ö–ò")
    logger.info("="*70)
    
    mean_cd, median_cd = None, None
    if cd_values:
        mean_cd = np.mean(cd_values) * 1000  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä—ã
        median_cd = np.median(cd_values) * 1000
        logger.info(f"üìè –°—Ä–µ–¥–Ω–∏–π Chamfer Distance: {mean_cd:.4f} –º–º")
        logger.info(f"üìè –ú–µ–¥–∏–∞–Ω–Ω—ã–π Chamfer Distance: {median_cd:.4f} –º–º")
        logger.info(f"üìè Min Chamfer Distance: {np.min(cd_values)*1000:.4f} –º–º")
        logger.info(f"üìè Max Chamfer Distance: {np.max(cd_values)*1000:.4f} –º–º")
    
    mean_iou, median_iou = None, None
    if iou_values:
        mean_iou = np.mean(iou_values)
        median_iou = np.median(iou_values)
        logger.info(f"üéØ –°—Ä–µ–¥–Ω–∏–π IoU: {mean_iou:.4f}")
        logger.info(f"üéØ –ú–µ–¥–∏–∞–Ω–Ω—ã–π IoU: {median_iou:.4f}")
        logger.info(f"üéØ Min IoU: {np.min(iou_values):.4f}")
        logger.info(f"üéØ Max IoU: {np.max(iou_values):.4f}")
        logger.info(f"üéØ Std IoU: {np.std(iou_values):.4f}")
    
    logger.info(f"‚ùå Invalidity Ratio: {invalid_ratio*100:.2f}%")
    logger.info(f"üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: {total_files}")
    logger.info(f"‚úÖ –í–∞–ª–∏–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: {valid_count}")
    logger.info("="*70)
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    summary_path = os.path.join(pred_eval_path, 'summary.txt')
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: {total_files}\n")
        f.write(f"–í–∞–ª–∏–¥–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π: {valid_count}\n")
        f.write(f"Invalidity Ratio: {invalid_ratio*100:.2f}%\n")
        
        if cd_values:
            f.write(f"\nChamfer Distance (–≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö):\n")
            f.write(f"–°—Ä–µ–¥–Ω–∏–π Chamfer Distance: {mean_cd:.4f}\n")
            f.write(f"–ú–µ–¥–∏–∞–Ω–Ω—ã–π Chamfer Distance: {median_cd:.4f}\n")
            f.write(f"Min Chamfer Distance: {np.min(cd_values)*1000:.4f}\n")
            f.write(f"Max Chamfer Distance: {np.max(cd_values)*1000:.4f}\n")
            f.write(f"Std Chamfer Distance: {np.std(cd_values)*1000:.4f}\n")
        
        if iou_values:
            f.write(f"\nIoU:\n")
            f.write(f"–°—Ä–µ–¥–Ω–∏–π IoU: {mean_iou:.4f}\n")
            f.write(f"–ú–µ–¥–∏–∞–Ω–Ω—ã–π IoU: {median_iou:.4f}\n")
            f.write(f"Min IoU: {np.min(iou_values):.4f}\n")
            f.write(f"Max IoU: {np.max(iou_values):.4f}\n")
            f.write(f"Std IoU: {np.std(iou_values):.4f}\n")
    
    logger.info(f"\nüíæ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ {summary_path}")
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    details_path = os.path.join(pred_eval_path, 'detailed_results.json')
    detailed_results = {
        'files': {file_name: {
            'cd': [float(cd) for cd in file_metrics.get('cd', [])],
            'iou': [float(iou) for iou in file_metrics.get('iou', [])],
            'cd_files': file_metrics.get('cd_files', []),
            'iou_files': file_metrics.get('iou_files', []),
            'best_file': best_names[i] if i < len(best_names) else None
        } for i, (file_name, file_metrics) in enumerate(metrics.items())},
        'summary': {
            'mean_cd_mm': float(mean_cd) if cd_values else None,
            'median_cd_mm': float(median_cd) if cd_values else None,
            'mean_iou': float(mean_iou) if iou_values else None,
            'median_iou': float(median_iou) if iou_values else None,
            'invalidity_ratio': float(invalid_ratio),
            'total_files': total_files,
            'valid_files': valid_count
        },
        'raw_results': [
            {
                'file_name': r['file_name'],
                'id': r['id'],
                'cd': float(r['cd']) if r['cd'] is not None else None,
                'iou': float(r['iou']) if r['iou'] is not None else None,
                'valid': r['valid'],
                'gt_path': r.get('gt_path', ''),
                'pred_path': r.get('pred_path', '')
            } for r in results
        ]
    }
    
    with open(details_path, 'w', encoding='utf-8') as f:
        json.dump(detailed_results, f, indent=2, ensure_ascii=False)
    
    logger.info(f"üíæ –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ {details_path}")
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    try:
        import matplotlib.pyplot as plt
        
        fig, axes = plt.subplots(1, 3 if cd_values and iou_values else 2, figsize=(15, 5))
        fig.suptitle('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –æ—Ü–µ–Ω–∫–∏', fontsize=16, fontweight='bold')
        
        if cd_values:
            ax = axes[0] if isinstance(axes, np.ndarray) else axes
            cd_mm = np.array(cd_values) * 1000
            ax.hist(cd_mm, bins=20, alpha=0.7, color='skyblue', edgecolor='black')
            ax.set_xlabel('Chamfer Distance (–º–º)', fontsize=12)
            ax.set_ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤', fontsize=12)
            ax.set_title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Chamfer Distance', fontsize=14, fontweight='bold')
            ax.grid(True, alpha=0.3)
            ax.axvline(np.mean(cd_mm), color='red', linestyle='dashed', linewidth=2, label=f'–°—Ä–µ–¥–Ω–µ–µ: {np.mean(cd_mm):.2f} –º–º')
            ax.legend()
        
        if iou_values:
            ax = axes[1] if isinstance(axes, np.ndarray) else axes
            ax.hist(iou_values, bins=20, alpha=0.7, color='lightgreen', edgecolor='black')
            ax.set_xlabel('IoU', fontsize=12)
            ax.set_ylabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤', fontsize=12)
            ax.set_title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ IoU', fontsize=14, fontweight='bold')
            ax.grid(True, alpha=0.3)
            ax.axvline(np.mean(iou_values), color='red', linestyle='dashed', linewidth=2, label=f'–°—Ä–µ–¥–Ω–µ–µ: {np.mean(iou_values):.4f}')
            ax.legend()
        
        if isinstance(axes, np.ndarray) and len(axes) > 2 and len(cd_values) == len(iou_values):
            ax = axes[2]
            cd_mm = np.array(cd_values) * 1000
            scatter = ax.scatter(cd_mm, iou_values, alpha=0.6, s=50, c='purple')
            ax.set_xlabel('Chamfer Distance (–º–º)', fontsize=12)
            ax.set_ylabel('IoU', fontsize=12)
            ax.set_title('CD vs IoU', fontsize=14, fontweight='bold')
            ax.grid(True, alpha=0.3)
        
        plt.tight_layout()
        plot_path = os.path.join(pred_eval_path, 'metrics_distribution.png')
        plt.savefig(plot_path, dpi=150, bbox_inches='tight')
        plt.close()
        
        logger.info(f"üìä –ì—Ä–∞—Ñ–∏–∫–∏ –º–µ—Ç—Ä–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ {plot_path}")
        
    except ImportError:
        logger.warning("‚ö†Ô∏è Matplotlib –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤.")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤: {e}")

if __name__ == '__main__':
    parser = ArgumentParser(description='–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –º–æ–¥–µ–ª–µ–π CAD –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º')
    parser.add_argument('--gt-mesh-path', type=str, default='./data/deepcad_test_mesh',
                        help='–ü—É—Ç—å –∫ ground truth –º–æ–¥–µ–ª—è–º')
    parser.add_argument('--pred-py-path', type=str, default='./work_dirs/tmp_py',
                        help='–ü—É—Ç—å –∫ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–º CadQuery –∫–æ–¥–∞–º')
    parser.add_argument('--pred-eval-path', type=str, default='./work_dirs/eval_results',
                        help='–ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ü–µ–Ω–∫–∏')
    parser.add_argument('--n-points', type=int, default=8192,
                        help='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –¥–ª—è Chamfer Distance')
    parser.add_argument('--num-workers', type=int, default=20,
                        help='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤')
    parser.add_argument('--check-models', action='store_true',
                        help='–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –º–æ–¥–µ–ª–µ–π –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å')
    parser.add_argument('--debug', action='store_true',
                        help='–í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ (–º–µ–Ω—å—à–µ —Ñ–∞–π–ª–æ–≤, –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏)')
    
    args = parser.parse_args()
    
    run(
        args.gt_mesh_path,
        args.pred_py_path,
        args.pred_eval_path,
        args.n_points,
        args.num_workers,
        args.check_models,
        args.debug
    )
    